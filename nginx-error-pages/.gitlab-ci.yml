.change_rules_nginx_error_page:
  rules:
    - changes:
        - nginx-error-pages/*

Lint nginx-error-pages:
  extends: .change_rules_nginx_error_page
  stage: "Quality"
  image: hadolint/hadolint:v1.17.6-debian
  script:
    - hadolint ./nginx-error-pages/Dockerfile

Build nginx-error-pages:
  extends:
    - .base_register_to_gitlab_stage
    - .change_rules_nginx_error_page
  stage: "Build"
  needs:
    - Lint nginx-error-pages

  variables:
    CONTEXT: nginx-error-pages
    IMAGE_NAME: ${CI_REGISTRY_IMAGE}/nginx-error-pages
    DOCKER_BUILD_ARGS: >-
      --build-arg CUSTOM_ERROR_PAGE_4XX=https://raw.githubusercontent.com/SocialGouv/maintenance/master/index.html
      --build-arg CUSTOM_ERROR_PAGE_5XX=https://raw.githubusercontent.com/SocialGouv/maintenance/master/index.html

Test nginx-error-pages:
  extends: .change_rules_nginx_error_page
  stage: "Test"
  needs:
    - Lint nginx-error-pages
    - Build nginx-error-pages
  image: docker:19
  services:
    - docker:19-dind
  script:
    - docker run
      --detach
      --env VERSION=x.y.z
      --name nginx-error-pages_test
      --publish 8080:8080
      --rm
      ${CI_REGISTRY_IMAGE}/nginx-error-pages:${CI_COMMIT_SHA}
    - docker ps
    - docker logs nginx-error-pages_test
    #
    - docker exec nginx-error-pages_test cat /www/4xx.html | grep "Maintenance"
    - docker exec nginx-error-pages_test cat /www/5xx.html | grep "Maintenance"
  after_script:
    - docker stop nginx-error-pages_test || true

# todo: change_rules_nginx_error_page should be applied too, but incompatible with only?
# error: jobs:publish nginx-error-pages to github registry config key may not be used with `rules`: only
Publish nginx-error-pages to Github Registry:
  extends:
    - .base_publish_to_github_stage
  needs:
    - Lint nginx-error-pages
    - Build nginx-error-pages
    - Test nginx-error-pages
  variables:
    IMAGE_NAME: socialgouv/docker/nginx-error-pages
