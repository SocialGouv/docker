Build socialgouv/docker/nginx4spa:
  stage: "Build"
  extends: .base_register_to_gitlab_stage
  variables:
    CONTEXT: nginx4spa
    IMAGE_NAME: ${CI_REGISTRY_IMAGE}/nginx4spa

Test socialgouv/docker/nginx4spa:
  stage: "Test"
  image: "${CI_REGISTRY_IMAGE}/nginx4spa:${CI_COMMIT_SHA}"
  cache:
    key: ${CI_JOB_NAME}-${CI_COMMIT_REF_SLUG}
    paths:
      - ${CI_PROJECT_DIR}/var/cache/apk
  variables:
    VERSION: x.y.z
    WWW_DIRECTORY: ${CI_PROJECT_DIR}/nginx4spa/test
  script:
    #
    # NOTE(douglasduteil): kill existing nginx demon
    # - kill $(ps aux | grep '[n]ginx' | awk '{print $1}')
    # NOTE(douglasduteil): ensure that nginx is serving the local test folder
    - ln -s ${CI_PROJECT_DIR}/nginx4spa/test /usr/share/nginx/html
    #
    - /envsub.sh
    #
    #
    - nginx
    #
    - apk --update add curl
    - curl -s localhost
    - curl -s localhost |
        grep "nginx4spa/test/index.html with VERSION=x.y.z"
    - curl -s localhost/foo/bar/bar.js
    - curl -s localhost/foo/bar/bar.js |
        grep "// nginx4spa/test/foo/bar/bar.js with VERSION=x.y.z"
    #
    - nginx -s stop

Publish socialgouv/docker/nginx4spa to Github Registry:
  extends: .base_publish_to_github_stage
  variables:
    IMAGE_NAME: socialgouv/docker/nginx4spa
