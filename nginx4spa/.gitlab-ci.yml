Build socialgouv/docker/nginx4spa:
  stage: "Build"
  extends: .base_register_to_gitlab_stage
  variables:
    CONTEXT: nginx4spa
    IMAGE_NAME: ${CI_REGISTRY_IMAGE}/nginx4spa

Test socialgouv/docker/nginx4spa:
  stage: "Test"
  image: docker:19
  services:
    - docker:19-dind
  script:
    - docker run
        --detach
        --env VERSION=x.y.z
        --name nginx4spa_test
        --publish 80
        --rm
        --volume ${CI_PROJECT_DIR}/nginx4spa/test:/usr/share/nginx/html
        ${CI_REGISTRY_IMAGE}/nginx4spa:${CI_COMMIT_SHA}
    #
    - apk --update add curl
    - curl -s localhost
    - curl -s localhost |
        grep "nginx4spa/test/index.html with VERSION=x.y.z"
    - curl -s localhost/foo/bar/bar.js
    - curl -s localhost/foo/bar/bar.js |
        grep "// nginx4spa/test/foo/bar/bar.js with VERSION=x.y.z"

Publish socialgouv/docker/nginx4spa to Github Registry:
  extends: .base_publish_to_github_stage
  variables:
    IMAGE_NAME: socialgouv/docker/nginx4spa
