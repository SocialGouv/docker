.change_rules_nginx4pa:
  rules:
    - changes:
        - nginx4spa/*

Lint nginx4spa:
  stage: "Quality"
  extends: .change_rules_nginx4pa
  image: hadolint/hadolint:v1.17.6-debian
  script:
    - hadolint ./nginx4spa/Dockerfile

Build nginx4spa:
  stage: "Build"
  needs:
    - Lint nginx4spa
  extends:
    - .base_register_to_gitlab_stage
    - .change_rules_nginx4pa
  variables:
    CONTEXT: nginx4spa
    IMAGE_NAME: ${CI_REGISTRY_IMAGE}/nginx4spa

Test nginx4spa:
  stage: "Test"
  extends: .change_rules_nginx4pa
  needs:
    - Lint nginx4spa
    - Build nginx4spa
  image: docker:19
  services:
    - docker:19-dind
  script:
    - docker run
      --detach
      --env VERSION=x.y.z
      --env PORT=90
      --name nginx4spa_test
      --publish 8888:90
      --rm
      --volume ${CI_PROJECT_DIR}/nginx4spa/test:/usr/share/nginx/html
      ${CI_REGISTRY_IMAGE}/nginx4spa:${CI_COMMIT_SHA}
    - docker ps
    - docker logs nginx4spa_test
    #
    - apk --update add curl
    - curl localhost:8888
    - curl -s localhost:8888 |
      grep "nginx4spa/test/index.html with VERSION=x.y.z"
    - curl -s localhost:8888/foo/bar/bar.js
    - curl -s localhost:8888/foo/bar/bar.js |
      grep "// nginx4spa/test/foo/bar/bar.js with VERSION=x.y.z"
  after_script:
    - docker stop nginx4spa_test || true

# todo: change_rules should be applied too, but incompatible with only?
# error: jobs:publish nginx4spa to github registry config key may not be used with `rules`: only
Publish nginx4spa to Github Registry:
  extends: .base_publish_to_github_stage
  needs:
    - Lint nginx4spa
    - Build nginx4spa
    - Test nginx4spa
  variables:
    IMAGE_NAME: socialgouv/docker/nginx4spa
